<div class="address-page__container">
  <div class="address-page__header">
    <a href="/account">
      <svg>
        <use xlink:href="#dark--back"/>
      </svg>
      Back to Account
    </a>
    <h2>Address Book</h2>
  </div>
  <div class="address-page__new-address">
    <button class="dark" onclick="toggleNewForm()">
      <svg>
        <use xlink:href="#light--plus"/>
      </svg>
      New Address
    </button>
    <div id="new-address-form" class="address-page__new-form hidden">
      {% form 'customer_address', customer.new_address %}
        <label for="AddressFirstNameNew">First Name</label>
        <input type="text" id="AddressFirstNameNew" name="address[first_name]" value="{{ form.first_name }}">

        <label for="AddressLastNameNew">Last Name</label>
        <input type="text" id="AddressLastNameNew" name="address[last_name]" value="{{ form.last_name }}">

        <label for="AddressCompanyNew">Company</label>
        <input type="text" id="AddressCompanyNew" name="address[company]" value="{{ form.company }}">

        <label for="AddressAddress1New">Address 1</label>
        <input type="text" id="AddressAddress1New" name="address[address1]" value="{{ form.address1 }}">

        <label for="AddressAddress2New">Address 2</label>
        <input type="text" id="AddressAddress2New" name="address[address2]" value="{{ form.address2 }}">

        <label for="AddressCityNew">City</label>
        <input type="text" id="AddressCityNew" name="address[city]" value="{{ form.city }}">

        <label for="AddressCountryNew">Country</label>
        <label for="AddressCountryNew" class="canadian-select no-grey">
          <select id="AddressCountryNew" name="address[country]" data-default="{{ form.country }}">
            {{ all_country_option_tags }}
          </select>
          <span class="canadian-select__wrapper">
            <span data-belongs-to="AddressCountryNew">
              United States
            </span>
            <svg data-arrow-for="AddressCountryNew">
              <use xlink:href="#dark--arrow_large_down"/>
            </svg>
          </span>
        </label>

        <div class="address-page__form-full-line" id="AddressProvinceNewContainer">
          <label for="AddressProvinceNew">Sate/Province</label>
          <label for="AddressProvinceNew" class="canadian-select no-grey">
            <select id="AddressProvinceNew" name="address[province]" data-default="{{ form.province }}">
              {{ all_Province_option_tags }}
            </select>
            <span class="canadian-select__wrapper">
              <span data-belongs-to="AddressProvinceNew">
                Alabama
              </span>
              <svg data-arrow-for="AddressProvinceNew">
                <use xlink:href="#dark--arrow_large_down"/>
              </svg>
            </span>
          </label>
        </div>

        <label for="AddressZipNew">Zip/Postal Code</label>
        <input type="text" id="AddressZipNew" name="address[zip]" value="{{ form.zip }}" autocapitalize="characters">

        <label for="AddressPhoneNew">Phone</label>
        <input type="tel" id="AddressPhoneNew" name="address[phone]" value="{{ form.phone }}">

        <label class="canadian-checkbox p2 weight-book no-grey" for="address_default_address_new">
          {{ form.set_as_default_checkbox }}
          <div class="canadian-checkbox__box border-charcoal--1px-50-t"></div>
          Set as default address
        </label>

        <input type="submit" class="button dark" value="Save Address">
        <a class="button light" onclick="cancelNewForm()">Cancel</a>
      {% endform %}
    </div>
  </div>
  <div class="address-page__address-list">
    {%- if customer.addresses.size > 0 -%}
      {% for address in customer.addresses %}
        <div class="address-page__address">
          {% if address == customer.default_address %}
            <b>Default</b>
          {% endif %}
          {{ address | format_address }}
          <div class="address-page__address__buttons">
            <a class="button dark" data-address-id="{{ address.id }}" onclick="toggleEditForm(event)">Edit</a>
            <a class="button light address-delete" data-address-id="{{ address.id }}" data-confirm-message="{{ customer.addresses.delete_confirm }}">Delete</a>
          </div>
          <div id="edit-address-form-{{ address.id }}" class="address-page__edit-form hidden">
            {% form 'customer_address', address %}
              <label for="AddressFirstNameEdit_{{ address.id }}">First Name</label>
              <input type="text" id="AddressFirstNameEdit_{{ address.id }}" name="address[first_name]" value="{{ form.first_name }}">

              <label for="AddressLastNameEdit_{{ address.id }}">Last Name</label>
              <input type="text" id="AddressLastNameEdit_{{ address.id }}" name="address[last_name]" value="{{ form.last_name }}">

              <label for="AddressCompanyEdit_{{ address.id }}">Company</label>
              <input type="text" id="AddressCompanyEdit_{{ address.id }}" name="address[company]" value="{{ form.company }}">

              <label for="AddressAddress1Edit_{{ address.id }}">Address 1</label>
              <input type="text" id="AddressAddress1Edit_{{ address.id }}" name="address[address1]" value="{{ form.address1 }}">

              <label for="AddressAddress2Edit_{{ address.id }}">Address 2</label>
              <input type="text" id="AddressAddress2Edit_{{ address.id }}" name="address[address2]" value="{{ form.address2 }}">

              <label for="AddressCityEdit_{{ address.id }}">City</label>
              <input type="text" id="AddressCityEdit_{{ address.id }}" name="address[city]" value="{{ form.city }}">

              <label for="AddressCountryEdit_{{ address.id }}">Country</label>
              <label for="AddressCountryEdit_{{ address.id }}" class="canadian-select no-grey">
                <select class="AddressCountryEdit" id="AddressCountryEdit_{{ address.id }}" name="address[country]" data-default="{{ form.country }}" data-address-id="{{ address.id }}">
                  {{ all_country_option_tags }}
                </select>
                <span class="canadian-select__wrapper">
                  <span data-belongs-to="AddressCountryEdit_{{ address.id }}">
                    {{ form.country }}
                  </span>
                  <svg data-arrow-for="AddressCountryEdit_{{ address.id }}">
                    <use xlink:href="#dark--arrow_large_down"/>
                  </svg>
                </span>
              </label>

              <div class="address-page__form-full-line" id="AddressProvinceEditContainer_{{ address.id }}">
                <label for="AddressProvinceEdit_{{ address.id }}">Sate/Province</label>
                <label for="AddressProvinceEdit_{{ address.id }}" class="canadian-select no-grey">
                  <select id="AddressProvinceEdit_{{ address.id }}" name="address[province]" data-default="{{ form.province }}">
                    {{ all_Province_option_tags }}
                  </select>
                  <span class="canadian-select__wrapper">
                    <span data-belongs-to="AddressProvinceEdit_{{ address.id }}">
                      {{ form.province }}
                    </span>
                    <svg data-arrow-for="AddressProvinceEdit_{{ address.id }}">
                      <use xlink:href="#dark--arrow_large_down"/>
                    </svg>
                  </span>
                </label>
              </div>

              <label for="AddressZipEdit_{{ address.id }}">Zip/Postal Code</label>
              <input type="text" id="AddressZipEdit_{{ address.id }}" name="address[zip]" value="{{ form.zip }}" autocapitalize="characters">

              <label for="AddressPhoneEdit_{{ address.id }}">Phone</label>
              <input type="tel" id="AddressPhoneEdit_{{ address.id }}" name="address[phone]" value="{{ form.phone }}">

              <label class="canadian-checkbox p2 weight-book no-grey" for="address_default_address_{{ form.id }}">
                {{ form.set_as_default_checkbox }}
                <div class="canadian-checkbox__box border-charcoal--1px-50-t"></div>
                Set as default address
              </label>

              <input type="submit" class="button dark" value="Save Address">
              <a class="button light" onclick="cancelEditForm(event)" data-address-id="{{ address.id }}">Cancel</a>
            {% endform %}
          </div>
        </div>
      {%- endfor -%}
    {%- else -%}
      Your Address Book is empty.
    {%- endif -%}
  </div>
</div>

<script>

let currentScroll

const toggleNewForm = ( ) => {
  currentScroll = document.documentElement.scrollTop
  const form = document.getElementById('new-address-form')
  form.classList.toggle('hidden')
}

const cancelNewForm = ( ) => {
  const form = document.getElementById('new-address-form')
  window.scroll({
    top: currentScroll,
    left: 0,
    behavior: 'smooth'
  })
  setTimeout(function(){ form.classList.toggle('hidden') }, 300)
  currentScroll = null
}

const toggleEditForm = (e) => {
  currentScroll = document.documentElement.scrollTop
  const addressId = e.target.dataset.addressId
  const form = document.getElementById(`edit-address-form-${ addressId }`)
  form.classList.toggle('hidden')
}

const cancelEditForm = (e) => {
  const addressId = e.target.dataset.addressId
  const form = document.getElementById(`edit-address-form-${ addressId }`)
  window.scroll({
    top: currentScroll,
    left: 0,
    behavior: 'smooth'
  })
  setTimeout(function(){ form.classList.toggle('hidden') }, 300)
  currentScroll = null
}



document.addEventListener("DOMContentLoaded", () => {
  new Shopify.CountryProvinceSelector('AddressCountryNew', 'AddressProvinceNew', {
    hideElement: 'AddressProvinceNewContainer'
  });

  const countrySelects = document.getElementsByClassName('AddressCountryEdit')

  for (let i = 0; i < countrySelects.length; i++) {
    const addressId = countrySelects[i].dataset.addressId
    new Shopify.CountryProvinceSelector(`AddressCountryEdit_${ addressId }`, `AddressProvinceEdit_${ addressId }`, {
      hideElement: `AddressProvinceEditContainer_${addressId}`
    });
  }

  const addressDeletes = document.getElementsByClassName('address-delete')

  Array.from(addressDeletes).forEach( deleteBtn => {
    deleteBtn.addEventListener("click", (e) => {
      if (confirm('Are you sure you want to delete this address?')) {
        Shopify.postLink('/account/addresses/' + e.target.dataset.addressId, {
          parameters: { _method: 'delete' }
        });
      }
    })
  })

});

</script>
